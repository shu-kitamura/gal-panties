# ギャルのパンティおくれ

ドラゴンボールの「ギャルのパンティおくれ」を再現するプロジェクトです。  
神龍（シェンロン）が「願いを言え。どんな願いもひとつだけ叶えてやろう」と告げた瞬間、ウーロンが横入りして「ギャルのパンティおくれーーーーーーっ！！！！！」と叫んで願いをかっさらう、あの名場面をネットワークで再現します。サーバが返そうとする最初の返答を、eBPF/XDP で“その場で”別のメッセージに書き換えて、まるでクライアントがそう言ったかのようにサーバへ送り返します。

## 使い方

### 環境

- Linux 環境（動作確認は Ubuntu 24.04 で実施）
- Rust
- [Development Environment](https://aya-rs.dev/book/start/development/)を参照して、必要なツールをインストールしてください。  

### 登場人物（バイナリ）

- `shenron`: TCP サーバ（デフォルト port 7777）。最初に「願いを言え…」と返す。
- `pilaf`: TCP クライアント。最初に「いでよ ドラゴン」を送る。
- `woolong`: eBPF ローダ。XDP を NIC に attach してパケットを改変する。

### 実行手順

1) サーバ・クライアントホストで、`cargo build` を実行
2) サーバ側ホストで `shenron` を実行
   ```
   ./target/debug/shenron -i <インタフェース>
   ```
3) クライアント側ホストで `woolong` を実行
   ```
   sudo ./target/debug/woolong -i <インタフェース> &
   ```
4) クライアント側ホストで `pilaf` を実行
   ```
   ./target/debug/pilaf -a <サーバのIPv4>
   ```

### 期待される挙動
- サーバ側コンソールに、最初にクライアントの「いでよ ドラゴン」が表示され、その後すぐに
	「> ギャルのパンティおくれーーーーーーっ！！！！！」が“クライアントから届いた入力”として表示されます。
- これは、サーバが本来返すはずだった「願いを言え…」という最初の返答を、クライアント側で XDP が奪い取り、
	ペイロードを書き換えてアドレスとポートを反転させ、即座にサーバへ送り返しているためです。

### 注意点

- XDP は基本的に NIC の受信（ingress）で動くため、ループバック(lo)経由の接続では動きません。クライアントとサーバを別ホストにするか、
	network namespaces/veth などでNIC 経由のパスを作ってください。
- ドライバが XDP_TX をサポートしていない場合は、SKB モードでの動作や別の NIC を検討してください。  
  SKBモードを使用する場合、`woolong/src/main.rs`の以下のように変更してください。
  ```diff
  -     program.attach(&iface, XdpFlags::default())
  +     program.attach(&iface, XdpFlags::SKB_MODE)
  ```
